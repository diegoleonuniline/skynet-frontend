<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalle Cliente - Skynet ISP</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .cliente-header {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      padding: 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      margin-bottom: 20px;
    }
    .cliente-avatar {
      width: 80px;
      height: 80px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
      flex-shrink: 0;
    }
    .cliente-info { flex: 1; }
    .cliente-nombre { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
    .cliente-numero { color: var(--text-muted); font-size: 14px; }
    .cliente-stats {
      display: flex;
      gap: 24px;
      margin-top: 16px;
    }
    .cliente-stat-item {
      text-align: center;
    }
    .cliente-stat-value {
      font-size: 20px;
      font-weight: 700;
    }
    .cliente-stat-label {
      font-size: 12px;
      color: var(--text-muted);
    }
    .equipo-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
    }
    .equipo-tipo {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 8px;
    }
    .equipo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }
    .equipo-item-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .equipo-item-value {
      font-size: 14px;
      font-weight: 500;
    }
    .cargo-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }
    .cargo-item:last-child { border-bottom: none; }
    .cargo-concepto { font-size: 14px; }
    .cargo-descripcion { font-size: 12px; color: var(--text-muted); }
    .cargo-monto { font-size: 14px; font-weight: 600; }
    .cargo-pendiente { color: var(--danger); }
    .cargo-pagado { color: var(--success); text-decoration: line-through; opacity: 0.7; }
    .pago-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    .pago-info { flex: 1; }
    .pago-monto { font-size: 18px; font-weight: 700; color: var(--success); }
    .calculo-live {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
      border: 1px solid var(--accent);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-top: 20px;
    }
    .calculo-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-weight: 600;
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <span class="material-symbols-outlined">cell_tower</span>
        </div>
        <span class="sidebar-title">Skynet ISP</span>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a href="dashboard.html" class="nav-item">
            <span class="material-symbols-outlined">dashboard</span>
            Dashboard
          </a>
          <a href="clientes.html" class="nav-item active">
            <span class="material-symbols-outlined">people</span>
            Clientes
          </a>
          <a href="pagos.html" class="nav-item">
            <span class="material-symbols-outlined">payments</span>
            Pagos
          </a>
        </div>
      </nav>
    </aside>
    <div class="sidebar-overlay"></div>

    <!-- Main Content -->
    <main class="main-content">
      <header class="topbar">
        <div class="topbar-left">
          <button class="btn-menu" onclick="toggleSidebar()">
            <span class="material-symbols-outlined">menu</span>
          </button>
          <a href="clientes.html" class="btn btn--ghost btn--sm">
            <span class="material-symbols-outlined">arrow_back</span>
          </a>
          <h1 class="page-title">Detalle del Cliente</h1>
        </div>
        <div class="topbar-right">
          <div class="user-info">
            <div>
              <div id="userName" class="user-name">Usuario</div>
              <div id="userRole" class="user-role">Rol</div>
            </div>
            <div id="userAvatar" class="user-avatar">US</div>
          </div>
        </div>
      </header>

      <div class="content-area">
        <!-- Header del Cliente -->
        <div class="cliente-header">
          <div id="clienteAvatar" class="cliente-avatar">??</div>
          <div class="cliente-info">
            <div id="clienteNombre" class="cliente-nombre">Cargando...</div>
            <div id="clienteNumero" class="cliente-numero"></div>
            <div id="clienteBadge"></div>
            <div class="cliente-stats">
              <div class="cliente-stat-item">
                <div id="statTarifa" class="cliente-stat-value">$0</div>
                <div class="cliente-stat-label">Tarifa Mensual</div>
              </div>
              <div class="cliente-stat-item">
                <div id="statAdeudo" class="cliente-stat-value text-danger">$0</div>
                <div class="cliente-stat-label">Adeudo Total</div>
              </div>
              <div class="cliente-stat-item">
                <div id="statFavor" class="cliente-stat-value text-success">$0</div>
                <div class="cliente-stat-label">Saldo a Favor</div>
              </div>
            </div>
          </div>
          <div class="btn-group">
            <button class="btn btn--success" onclick="abrirModalPago()">
              <span class="material-symbols-outlined">payments</span>
              Registrar Pago
            </button>
            <button class="btn btn--secondary" onclick="editarCliente()">
              <span class="material-symbols-outlined">edit</span>
              Editar
            </button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="card">
          <div class="tabs">
            <button class="tab active" data-tab="tabEstadoCuenta">Estado de Cuenta</button>
            <button class="tab" data-tab="tabInstalacion">Instalaci√≥n</button>
            <button class="tab" data-tab="tabEquipos">Equipos</button>
            <button class="tab" data-tab="tabPagos">Historial Pagos</button>
            <button class="tab" data-tab="tabInfo">Informaci√≥n</button>
          </div>
          <div class="tab-contents">
            <!-- Tab Estado de Cuenta -->
            <div id="tabEstadoCuenta" class="tab-content active">
              <div class="card-body">
                <div id="sinInstalacion" class="empty-state hidden">
                  <span class="material-symbols-outlined">construction</span>
                  <h3>Sin instalaci√≥n registrada</h3>
                  <p>Registra la instalaci√≥n para generar los cargos iniciales</p>
                  <button class="btn btn--primary mt-2" onclick="activarTabInstalacion()">
                    <span class="material-symbols-outlined">add</span>
                    Registrar Instalaci√≥n
                  </button>
                </div>
                <div id="estadoCuentaContent">
                  <!-- Instalaci√≥n pendiente -->
                  <div id="seccionInstalacion" class="hidden">
                    <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <span class="material-symbols-outlined">construction</span>
                      Instalaci√≥n
                    </h4>
                    <div id="cargoInstalacion" class="cargo-item"></div>
                  </div>
                  
                  <!-- Mensualidades pendientes -->
                  <div id="seccionMensualidades" class="mt-2">
                    <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                      <span class="material-symbols-outlined">calendar_month</span>
                      Mensualidades
                    </h4>
                    <div id="listaMensualidades"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tab Instalaci√≥n -->
            <div id="tabInstalacion" class="tab-content">
              <div class="card-body">
                <div id="instalacionExistente" class="hidden">
                  <div class="stat-card" style="border-left: 3px solid var(--success);">
                    <div class="stat-icon stat-icon--success">
                      <span class="material-symbols-outlined">check_circle</span>
                    </div>
                    <div class="stat-info">
                      <div class="stat-label">Instalaci√≥n Registrada</div>
                      <div id="fechaInstalacion" class="stat-value" style="font-size: 18px;">-</div>
                      <div id="tecnicoInstalador" class="text-muted"></div>
                    </div>
                  </div>
                </div>

                <form id="formInstalacion" onsubmit="registrarInstalacion(event)">
                  <h4 style="margin-bottom: 16px;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">settings</span>
                    Datos de Instalaci√≥n
                  </h4>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label form-label--required">Fecha de Instalaci√≥n</label>
                      <input type="date" id="fecha_instalacion" class="form-input" required onchange="calcularCargosLive()">
                    </div>
                    <div class="form-group">
                      <label class="form-label">D√≠a de Corte</label>
                      <input type="number" id="dia_corte" class="form-input" value="10" min="1" max="28" onchange="calcularCargosLive()">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label form-label--required">Tarifa Mensual</label>
                      <input type="number" id="tarifa_mensual" class="form-input" step="0.01" required onchange="calcularCargosLive()">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Costo de Instalaci√≥n</label>
                      <input type="number" id="costo_instalacion" class="form-input" step="0.01" value="0" onchange="calcularCargosLive()">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label class="form-label">T√©cnico Instalador</label>
                      <input type="text" id="tecnico_instalador" class="form-input">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Notas de Instalaci√≥n</label>
                    <textarea id="notas_instalacion" class="form-textarea" rows="2"></textarea>
                  </div>

                  <!-- Equipos -->
                  <h4 style="margin: 24px 0 16px;">
                    <span class="material-symbols-outlined" style="vertical-align: middle;">router</span>
                    Equipos
                  </h4>
                  
                  <!-- Antena -->
                  <div class="equipo-card">
                    <div class="equipo-tipo">üì° Antena</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">MAC</label>
                        <input type="text" id="antena_mac" class="form-input" placeholder="A8:C9:12:34:4B:35">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Marca</label>
                        <input type="text" id="antena_marca" class="form-input" placeholder="CISCO">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Modelo</label>
                        <input type="text" id="antena_modelo" class="form-input" placeholder="X1">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">IP</label>
                        <input type="text" id="antena_ip" class="form-input" placeholder="10.10.1.3">
                      </div>
                      <div class="form-group">
                        <label class="form-label">SSID</label>
                        <input type="text" id="antena_ssid" class="form-input" placeholder="AUT">
                      </div>
                    </div>
                  </div>

                  <!-- Router -->
                  <div class="equipo-card">
                    <div class="equipo-tipo">üì∂ Router</div>
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">MAC</label>
                        <input type="text" id="router_mac" class="form-input" placeholder="09:18:D6:98:EB:B2">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Marca</label>
                        <input type="text" id="router_marca" class="form-input" placeholder="TP-LINK">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Modelo</label>
                        <input type="text" id="router_modelo" class="form-input" placeholder="TL-WR850N">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">IP</label>
                        <input type="text" id="router_ip" class="form-input" placeholder="192.168.0.1">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Serie</label>
                        <input type="text" id="router_serie" class="form-input" placeholder="2243591018710">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label class="form-label">Nombre de Red</label>
                        <input type="text" id="router_nombre_red" class="form-input" placeholder="TP-LINK_EBC2">
                      </div>
                      <div class="form-group">
                        <label class="form-label">Contrase√±a</label>
                        <input type="text" id="router_contrasena" class="form-input" placeholder="123456">
                      </div>
                    </div>
                  </div>

                  <!-- C√°lculo en Vivo -->
                  <div id="calculoLive" class="calculo-live hidden">
                    <div class="calculo-header">
                      <span class="material-symbols-outlined">calculate</span>
                      Resumen de Cargos a Generar
                    </div>
                    <div id="listaCargosCalculo"></div>
                    <div class="resumen-total">
                      <span class="resumen-total-label">TOTAL ADEUDO INICIAL:</span>
                      <span id="totalAdeudoCalculo" class="resumen-total-monto">$0.00</span>
                    </div>
                  </div>

                  <div class="mt-3">
                    <button type="submit" class="btn btn--primary btn--lg" id="btnRegistrarInstalacion">
                      <span class="material-symbols-outlined">check</span>
                      Confirmar Instalaci√≥n
                    </button>
                  </div>
                </form>
              </div>
            </div>

            <!-- Tab Equipos -->
            <div id="tabEquipos" class="tab-content">
              <div class="card-body">
                <div id="listaEquipos">
                  <div class="text-center text-muted">Sin equipos registrados</div>
                </div>
              </div>
            </div>

            <!-- Tab Historial Pagos -->
            <div id="tabPagos" class="tab-content">
              <div class="card-body card-body--no-padding">
                <div id="listaPagos" class="table-container">
                  <div class="text-center text-muted" style="padding: 40px;">Sin pagos registrados</div>
                </div>
              </div>
            </div>

            <!-- Tab Informaci√≥n -->
            <div id="tabInfo" class="tab-content">
              <div class="card-body">
                <div id="infoCliente"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal Pago -->
  <div id="modalPago" class="modal-overlay" onclick="cerrarModalOverlay(event)">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Registrar Pago</h3>
        <button class="modal-close" onclick="cerrarModal('modalPago')">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <form id="formPago" onsubmit="registrarPago(event)">
        <div class="modal-body">
          <!-- Resumen -->
          <div style="display: flex; gap: 16px; margin-bottom: 20px;">
            <div style="flex: 1; background: var(--danger-light); padding: 16px; border-radius: var(--radius); text-align: center;">
              <div class="text-muted" style="font-size: 12px;">Adeudo Total</div>
              <div id="pagoAdeudo" class="text-danger font-bold" style="font-size: 24px;">$0</div>
            </div>
            <div style="flex: 1; background: var(--success-light); padding: 16px; border-radius: var(--radius); text-align: center;">
              <div class="text-muted" style="font-size: 12px;">Saldo a Favor</div>
              <div id="pagoFavor" class="text-success font-bold" style="font-size: 24px;">$0</div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label form-label--required">Monto a Pagar</label>
            <input type="number" id="pago_monto" class="form-input" step="0.01" required style="font-size: 24px; text-align: center; font-weight: 700;">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">M√©todo de Pago</label>
              <select id="pago_metodo" class="form-select">
                <option value="">Seleccionar...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Tipo de Banco</label>
              <input type="text" id="pago_tipo_banco" class="form-input" placeholder="OXXO, Transferencia...">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Referencia / Folio</label>
              <input type="text" id="pago_referencia" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">N√∫mero de Recibo</label>
              <input type="text" id="pago_numero_recibo" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">¬øQui√©n Env√≠a el Pago?</label>
              <input type="text" id="pago_quien_paga" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">Tel√©fono</label>
              <input type="tel" id="pago_telefono_quien_paga" class="form-input">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Observaciones</label>
            <textarea id="pago_observaciones" class="form-textarea" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn--secondary" onclick="cerrarModal('modalPago')">Cancelar</button>
          <button type="submit" class="btn btn--success" id="btnGuardarPago">
            <span class="material-symbols-outlined">check</span>
            Registrar Pago
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    let clienteId = null;
    let clienteData = null;

    document.addEventListener('DOMContentLoaded', async () => {
      clienteId = getQueryParam('id');
      if (!clienteId) {
        window.location.href = 'clientes.html';
        return;
      }

      await cargarCliente();
      await cargarEstadoCuenta();
      await cargarEquipos();
      await cargarPagos();
      await cargarMetodosPago();

      // Si viene de crear nuevo, activar tab instalaci√≥n
      if (getQueryParam('nuevo') === '1') {
        activarTabInstalacion();
      }

      // Inicializar fecha de hoy
      document.getElementById('fecha_instalacion').valueAsDate = new Date();
    });

    async function cargarCliente() {
      const data = await fetchGet(`/api/clientes/${clienteId}`);
      if (!data.ok) {
        toastError('Cliente no encontrado');
        window.location.href = 'clientes.html';
        return;
      }

      clienteData = data.cliente;
      const c = clienteData;

      document.getElementById('clienteAvatar').textContent = obtenerIniciales(c.nombre, c.apellido_paterno);
      document.getElementById('clienteNombre').textContent = `${c.nombre} ${c.apellido_paterno || ''} ${c.apellido_materno || ''}`;
      document.getElementById('clienteNumero').textContent = c.numero_cliente || '';
      document.getElementById('clienteBadge').innerHTML = `<span class="badge badge--${c.estado === 'activo' ? 'success' : c.estado === 'suspendido' ? 'warning' : 'danger'}">${c.estado}</span>`;
      
      document.getElementById('statTarifa').textContent = formatoMoneda(c.tarifa_mensual || c.cuota_mensual);
      document.getElementById('statAdeudo').textContent = formatoMoneda(c.saldo_pendiente);
      document.getElementById('statFavor').textContent = formatoMoneda(c.saldo_favor);

      // Info
      document.getElementById('infoCliente').innerHTML = `
        <div class="form-row">
          <div><strong>Tel√©fono:</strong> ${c.telefono || '-'}</div>
          <div><strong>Tel. Secundario:</strong> ${c.telefono_secundario || '-'}</div>
          <div><strong>Tel. Terciario:</strong> ${c.telefono_terciario || '-'}</div>
        </div>
        <div class="form-row mt-2">
          <div><strong>Email:</strong> ${c.email || '-'}</div>
          <div><strong>Ciudad:</strong> ${c.ciudad_nombre || '-'}</div>
          <div><strong>Colonia:</strong> ${c.colonia_nombre || '-'}</div>
        </div>
        <div class="mt-2">
          <strong>Direcci√≥n:</strong> ${c.direccion_calle || ''} ${c.direccion_numero || ''} ${c.direccion_interior ? 'Int. ' + c.direccion_interior : ''}, ${c.colonia_nombre || ''}, ${c.ciudad_nombre || ''} ${c.codigo_postal || ''}
        </div>
        <div class="mt-2"><strong>Referencia:</strong> ${c.referencia || '-'}</div>
        ${c.ine_frente ? `<div class="mt-2"><strong>INE Frente:</strong> <a href="${c.ine_frente}" target="_blank">Ver imagen</a></div>` : ''}
        ${c.ine_reverso ? `<div class="mt-1"><strong>INE Reverso:</strong> <a href="${c.ine_reverso}" target="_blank">Ver imagen</a></div>` : ''}
      `;

      // Si ya tiene instalaci√≥n, mostrar datos
      if (c.fecha_instalacion) {
        document.getElementById('instalacionExistente').classList.remove('hidden');
        document.getElementById('formInstalacion').classList.add('hidden');
        document.getElementById('fechaInstalacion').textContent = formatoFecha(c.fecha_instalacion);
        document.getElementById('tecnicoInstalador').textContent = c.tecnico_instalador ? `T√©cnico: ${c.tecnico_instalador}` : '';
      }
    }

    async function cargarEstadoCuenta() {
      const data = await fetchGet(`/api/pagos/estado-cuenta/${clienteId}`);
      
      if (!data.ok) return;

      // Si no hay instalaci√≥n ni mensualidades
      if (!data.instalacion && (!data.mensualidades || data.mensualidades.length === 0)) {
        document.getElementById('sinInstalacion').classList.remove('hidden');
        document.getElementById('estadoCuentaContent').classList.add('hidden');
        return;
      }

      document.getElementById('sinInstalacion').classList.add('hidden');
      document.getElementById('estadoCuentaContent').classList.remove('hidden');

      // Instalaci√≥n
      if (data.instalacion && data.instalacion.saldo > 0) {
        document.getElementById('seccionInstalacion').classList.remove('hidden');
        document.getElementById('cargoInstalacion').innerHTML = `
          <div>
            <div class="cargo-concepto">Costo de Instalaci√≥n</div>
            <div class="cargo-descripcion">Fecha: ${formatoFecha(data.instalacion.fecha_instalacion)}</div>
          </div>
          <div>
            <span class="${data.instalacion.estado === 'pagado' ? 'cargo-pagado' : 'cargo-pendiente'}">${formatoMoneda(data.instalacion.saldo)}</span>
            ${data.instalacion.monto_pagado > 0 ? `<div class="cargo-descripcion">Pagado: ${formatoMoneda(data.instalacion.monto_pagado)}</div>` : ''}
          </div>
        `;
      } else {
        document.getElementById('seccionInstalacion').classList.add('hidden');
      }

      // Mensualidades
      const listaMens = document.getElementById('listaMensualidades');
      if (data.mensualidades && data.mensualidades.length > 0) {
        listaMens.innerHTML = data.mensualidades.map(m => {
          const esProrrateo = m.es_prorrateado;
          const concepto = esProrrateo ? `Prorrateo (${m.dias_prorrateados} d√≠as)` : `Mensualidad ${m.periodo}`;
          const isPagado = m.estado === 'pagado';
          const isVencido = new Date(m.fecha_vencimiento) < new Date() && !isPagado;
          
          return `
            <div class="cargo-item">
              <div>
                <div class="cargo-concepto">${concepto}</div>
                <div class="cargo-descripcion">
                  Vence: ${formatoFechaCorta(m.fecha_vencimiento)}
                  ${isVencido ? '<span class="badge badge--danger" style="margin-left: 8px;">Vencido</span>' : ''}
                </div>
              </div>
              <div class="text-right">
                <div class="${isPagado ? 'cargo-pagado' : 'cargo-pendiente'}">${formatoMoneda(m.saldo)}</div>
                ${m.monto_pagado > 0 && !isPagado ? `<div class="cargo-descripcion">Pagado: ${formatoMoneda(m.monto_pagado)}</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
      } else {
        listaMens.innerHTML = '<div class="text-center text-muted" style="padding: 20px;">Sin cargos pendientes üéâ</div>';
      }

      // Actualizar stats
      document.getElementById('statAdeudo').textContent = formatoMoneda(data.total_adeudo);
      document.getElementById('statFavor').textContent = formatoMoneda(data.saldo_favor);
    }

    async function cargarEquipos() {
      const data = await fetchGet(`/api/instalaciones/${clienteId}`);
      
      if (!data.ok || !data.equipos || data.equipos.length === 0) {
        document.getElementById('listaEquipos').innerHTML = '<div class="text-center text-muted">Sin equipos registrados</div>';
        return;
      }

      document.getElementById('listaEquipos').innerHTML = data.equipos.map(e => `
        <div class="equipo-card">
          <div class="equipo-tipo">${e.tipo === 'antena' ? 'üì°' : 'üì∂'} ${e.tipo}</div>
          <div class="equipo-grid">
            <div>
              <div class="equipo-item-label">MAC</div>
              <div class="equipo-item-value">${e.mac || '-'}</div>
            </div>
            <div>
              <div class="equipo-item-label">Marca</div>
              <div class="equipo-item-value">${e.marca || '-'}</div>
            </div>
            <div>
              <div class="equipo-item-label">Modelo</div>
              <div class="equipo-item-value">${e.modelo || '-'}</div>
            </div>
            <div>
              <div class="equipo-item-label">IP</div>
              <div class="equipo-item-value">${e.ip || '-'}</div>
            </div>
            ${e.tipo === 'antena' ? `
              <div>
                <div class="equipo-item-label">SSID</div>
                <div class="equipo-item-value">${e.ssid || '-'}</div>
              </div>
            ` : `
              <div>
                <div class="equipo-item-label">Serie</div>
                <div class="equipo-item-value">${e.serie || '-'}</div>
              </div>
              <div>
                <div class="equipo-item-label">Red</div>
                <div class="equipo-item-value">${e.nombre_red || '-'}</div>
              </div>
              <div>
                <div class="equipo-item-label">Contrase√±a</div>
                <div class="equipo-item-value">${e.contrasena_red || '-'}</div>
              </div>
            `}
          </div>
        </div>
      `).join('');
    }

    async function cargarPagos() {
      const data = await fetchGet(`/api/pagos/historial/${clienteId}`);
      
      if (!data.ok || !data.pagos || data.pagos.length === 0) {
        document.getElementById('listaPagos').innerHTML = '<div class="text-center text-muted" style="padding: 40px;">Sin pagos registrados</div>';
        return;
      }

      document.getElementById('listaPagos').innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>M√©todo</th>
              <th>Referencia</th>
              <th>Qui√©n Paga</th>
              <th class="text-right">Monto</th>
            </tr>
          </thead>
          <tbody>
            ${data.pagos.map(p => `
              <tr>
                <td>${formatoFechaHora(p.fecha_pago)}</td>
                <td>${p.metodo_nombre || p.tipo_banco || '-'}</td>
                <td>${p.referencia || p.numero_recibo || '-'}</td>
                <td>${p.quien_paga || '-'}</td>
                <td class="text-right text-success font-bold">${formatoMoneda(p.monto)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function cargarMetodosPago() {
      const data = await fetchGet('/api/pagos/metodos');
      if (data.ok) {
        const select = document.getElementById('pago_metodo');
        data.metodos.forEach(m => {
          select.innerHTML += `<option value="${m.id}">${m.nombre}</option>`;
        });
      }
    }

    function activarTabInstalacion() {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector('[data-tab="tabInstalacion"]').classList.add('active');
      document.getElementById('tabInstalacion').classList.add('active');
    }

    async function calcularCargosLive() {
      const fecha = document.getElementById('fecha_instalacion').value;
      const tarifa = parseFloat(document.getElementById('tarifa_mensual').value) || 0;
      const instalacion = parseFloat(document.getElementById('costo_instalacion').value) || 0;
      const diaCorte = parseInt(document.getElementById('dia_corte').value) || 10;

      if (!fecha || tarifa <= 0) {
        document.getElementById('calculoLive').classList.add('hidden');
        return;
      }

      const data = await fetchPost('/api/instalaciones/calcular', {
        fecha_instalacion: fecha,
        tarifa_mensual: tarifa,
        costo_instalacion: instalacion,
        dia_corte: diaCorte
      });

      if (data.ok) {
        document.getElementById('calculoLive').classList.remove('hidden');
        
        let html = '';
        data.cargos.forEach(c => {
          html += `
            <div class="resumen-item">
              <div>
                <div class="resumen-concepto">${c.concepto}</div>
                ${c.descripcion ? `<div class="resumen-descripcion">${c.descripcion}</div>` : ''}
              </div>
              <div class="resumen-monto">${formatoMoneda(c.monto)}</div>
            </div>
          `;
        });
        
        document.getElementById('listaCargosCalculo').innerHTML = html;
        document.getElementById('totalAdeudoCalculo').textContent = formatoMoneda(data.total_adeudo);
      }
    }

    async function registrarInstalacion(e) {
      e.preventDefault();
      const btn = document.getElementById('btnRegistrarInstalacion');
      btnLoading(btn, true);

      const datos = {
        cliente_id: clienteId,
        fecha_instalacion: document.getElementById('fecha_instalacion').value,
        tarifa_mensual: parseFloat(document.getElementById('tarifa_mensual').value),
        costo_instalacion: parseFloat(document.getElementById('costo_instalacion').value) || 0,
        dia_corte: parseInt(document.getElementById('dia_corte').value) || 10,
        tecnico_instalador: document.getElementById('tecnico_instalador').value,
        notas_instalacion: document.getElementById('notas_instalacion').value,
        // Antena
        antena_mac: document.getElementById('antena_mac').value,
        antena_marca: document.getElementById('antena_marca').value,
        antena_modelo: document.getElementById('antena_modelo').value,
        antena_ip: document.getElementById('antena_ip').value,
        antena_ssid: document.getElementById('antena_ssid').value,
        // Router
        router_mac: document.getElementById('router_mac').value,
        router_marca: document.getElementById('router_marca').value,
        router_modelo: document.getElementById('router_modelo').value,
        router_ip: document.getElementById('router_ip').value,
        router_serie: document.getElementById('router_serie').value,
        router_nombre_red: document.getElementById('router_nombre_red').value,
        router_contrasena: document.getElementById('router_contrasena').value
      };

      const data = await fetchPost('/api/instalaciones', datos);
      btnLoading(btn, false);

      if (data.ok) {
        toastExito('Instalaci√≥n registrada correctamente');
        
        // Mostrar resumen
        let mensaje = 'Cargos generados:\n';
        data.cargos_generados.forEach(c => {
          mensaje += `‚Ä¢ ${c.concepto}: ${formatoMoneda(c.monto)}\n`;
        });
        mensaje += `\nTotal adeudo: ${formatoMoneda(data.total_adeudo)}`;
        alert(mensaje);

        // Recargar p√°gina
        location.reload();
      } else {
        toastError(data.mensaje || 'Error al registrar instalaci√≥n');
      }
    }

    function abrirModalPago() {
      document.getElementById('formPago').reset();
      document.getElementById('pagoAdeudo').textContent = formatoMoneda(clienteData?.saldo_pendiente || 0);
      document.getElementById('pagoFavor').textContent = formatoMoneda(clienteData?.saldo_favor || 0);
      document.getElementById('pago_monto').value = clienteData?.saldo_pendiente || '';
      abrirModal('modalPago');
    }

    async function registrarPago(e) {
      e.preventDefault();
      const btn = document.getElementById('btnGuardarPago');
      btnLoading(btn, true);

      const datos = {
        cliente_id: clienteId,
        monto: parseFloat(document.getElementById('pago_monto').value),
        metodo_pago_id: document.getElementById('pago_metodo').value || null,
        tipo_banco: document.getElementById('pago_tipo_banco').value,
        referencia: document.getElementById('pago_referencia').value,
        numero_recibo: document.getElementById('pago_numero_recibo').value,
        quien_paga: document.getElementById('pago_quien_paga').value,
        telefono_quien_paga: document.getElementById('pago_telefono_quien_paga').value,
        observaciones: document.getElementById('pago_observaciones').value
      };

      const data = await fetchPost('/api/pagos', datos);
      btnLoading(btn, false);

      if (data.ok) {
        cerrarModal('modalPago');
        
        // Mostrar resumen de aplicaci√≥n
        let mensaje = `‚úÖ Pago registrado: ${formatoMoneda(datos.monto)}\n\nAplicado a:\n`;
        data.detalle.forEach(d => {
          mensaje += `‚Ä¢ ${d.concepto}: ${formatoMoneda(d.monto_aplicado)} (${d.estado_nuevo})\n`;
        });
        if (data.nuevo_saldo_favor > 0) {
          mensaje += `\nüíö Saldo a favor: ${formatoMoneda(data.nuevo_saldo_favor)}`;
        }
        alert(mensaje);

        // Recargar datos
        await cargarCliente();
        await cargarEstadoCuenta();
        await cargarPagos();
        
        toastExito('Pago registrado correctamente');
      } else {
        toastError(data.mensaje || 'Error al registrar pago');
      }
    }

    function editarCliente() {
      window.location.href = `clientes.html?editar=${clienteId}`;
    }
  </script>
</body>
</html>
