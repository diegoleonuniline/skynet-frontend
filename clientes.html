<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clientes - Skynet ISP</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <span class="material-symbols-outlined">cell_tower</span>
        </div>
        <span class="sidebar-title">Skynet ISP</span>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a href="dashboard.html" class="nav-item">
            <span class="material-symbols-outlined">dashboard</span>
            Dashboard
          </a>
          <a href="clientes.html" class="nav-item active">
            <span class="material-symbols-outlined">people</span>
            Clientes
          </a>
          <a href="pagos.html" class="nav-item">
            <span class="material-symbols-outlined">payments</span>
            Pagos
          </a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Reportes</div>
          <a href="reportes.html?tipo=adeudos" class="nav-item">
            <span class="material-symbols-outlined">warning</span>
            Adeudos
          </a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Sistema</div>
          <a href="catalogos.html" class="nav-item">
            <span class="material-symbols-outlined">category</span>
            Catálogos
          </a>
        </div>
      </nav>
    </aside>
    <div class="sidebar-overlay"></div>

    <!-- Main Content -->
    <main class="main-content">
      <header class="topbar">
        <div class="topbar-left">
          <button class="btn-menu" onclick="toggleSidebar()">
            <span class="material-symbols-outlined">menu</span>
          </button>
          <h1 class="page-title">Clientes</h1>
        </div>
        <div class="topbar-right">
          <div class="user-info">
            <div>
              <div id="userName" class="user-name">Usuario</div>
              <div id="userRole" class="user-role">Rol</div>
            </div>
            <div id="userAvatar" class="user-avatar">US</div>
          </div>
          <button class="btn btn--ghost" onclick="cerrarSesion()" title="Cerrar sesión">
            <span class="material-symbols-outlined">logout</span>
          </button>
        </div>
      </header>

      <div class="content-area">
        <!-- Filtros y Acciones -->
        <div class="card mb-2">
          <div class="card-body">
            <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between;">
              <div style="display: flex; flex-wrap: wrap; gap: 12px; flex: 1;">
                <input type="text" id="inputBusqueda" class="form-input" placeholder="Buscar cliente..." style="max-width: 300px;">
                <select id="selectEstado" class="form-select" style="max-width: 150px;">
                  <option value="todos">Todos</option>
                  <option value="activo" selected>Activos</option>
                  <option value="suspendido">Suspendidos</option>
                  <option value="cancelado">Cancelados</option>
                </select>
                <select id="selectCiudad" class="form-select" style="max-width: 200px;">
                  <option value="">Todas las ciudades</option>
                </select>
              </div>
              <button class="btn btn--primary" onclick="abrirModalCliente()">
                <span class="material-symbols-outlined">person_add</span>
                Nuevo Cliente
              </button>
            </div>
          </div>
        </div>

        <!-- Tabla de Clientes -->
        <div class="card">
          <div class="card-body card-body--no-padding">
            <div class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th>Teléfono</th>
                    <th>Ciudad</th>
                    <th>Tarifa</th>
                    <th>Saldo</th>
                    <th>Estado</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tablaClientes">
                  <tr><td colspan="7" class="text-center text-muted">Cargando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          <!-- Paginación -->
          <div class="card-body" style="border-top: 1px solid var(--border);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
              <div id="infoRegistros" class="text-muted" style="font-size: 13px;">Mostrando 0 de 0</div>
              <div id="paginacion" class="btn-group"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal Crear/Editar Cliente -->
  <div id="modalCliente" class="modal-overlay" onclick="cerrarModalOverlay(event)">
    <div class="modal modal--lg">
      <div class="modal-header">
        <h3 id="modalClienteTitulo" class="modal-title">Nuevo Cliente</h3>
        <button class="modal-close" onclick="cerrarModal('modalCliente')">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <form id="formCliente" onsubmit="guardarCliente(event)">
        <div class="modal-body">
          <input type="hidden" id="clienteId">
          
          <!-- Datos Personales -->
          <h4 style="margin-bottom: 16px; font-size: 14px; color: var(--text-secondary);">
            <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle;">person</span>
            Datos Personales
          </h4>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label form-label--required">Nombre</label>
              <input type="text" id="nombre" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Apellido Paterno</label>
              <input type="text" id="apellido_paterno" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">Apellido Materno</label>
              <input type="text" id="apellido_materno" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label form-label--required">Teléfono Principal</label>
              <input type="tel" id="telefono" class="form-input" required>
            </div>
            <div class="form-group">
              <label class="form-label">Teléfono Secundario</label>
              <input type="tel" id="telefono_secundario" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">Teléfono Terciario (Sub-cliente)</label>
              <input type="tel" id="telefono_terciario" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" id="email" class="form-input">
            </div>
          </div>

          <!-- Dirección -->
          <h4 style="margin: 24px 0 16px; font-size: 14px; color: var(--text-secondary);">
            <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle;">home</span>
            Dirección
          </h4>
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label class="form-label">Calle</label>
              <input type="text" id="direccion_calle" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">Número</label>
              <input type="text" id="direccion_numero" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">Interior</label>
              <input type="text" id="direccion_interior" class="form-input">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Ciudad</label>
              <select id="ciudad_id" class="form-select">
                <option value="">Seleccionar...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Colonia</label>
              <select id="colonia_id" class="form-select">
                <option value="">Seleccionar...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Código Postal</label>
              <input type="text" id="codigo_postal" class="form-input" maxlength="5">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Referencia</label>
            <textarea id="referencia" class="form-textarea" rows="2" placeholder="Casa color azul, frente al parque..."></textarea>
          </div>

          <!-- INE -->
          <h4 style="margin: 24px 0 16px; font-size: 14px; color: var(--text-secondary);">
            <span class="material-symbols-outlined" style="font-size: 18px; vertical-align: middle;">badge</span>
            Identificación (INE)
          </h4>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">INE Frente</label>
              <div class="upload-area" onclick="document.getElementById('inputIneFrente').click()">
                <span class="material-symbols-outlined">upload</span>
                <div class="upload-text">Clic para subir</div>
                <img id="previewIneFrente" class="upload-preview hidden">
              </div>
              <input type="file" id="inputIneFrente" accept="image/*" hidden onchange="previewImage(this, 'previewIneFrente', 'ine_frente')">
              <input type="hidden" id="ine_frente">
            </div>
            <div class="form-group">
              <label class="form-label">INE Reverso</label>
              <div class="upload-area" onclick="document.getElementById('inputIneReverso').click()">
                <span class="material-symbols-outlined">upload</span>
                <div class="upload-text">Clic para subir</div>
                <img id="previewIneReverso" class="upload-preview hidden">
              </div>
              <input type="file" id="inputIneReverso" accept="image/*" hidden onchange="previewImage(this, 'previewIneReverso', 'ine_reverso')">
              <input type="hidden" id="ine_reverso">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn--secondary" onclick="cerrarModal('modalCliente')">Cancelar</button>
          <button type="submit" class="btn btn--primary" id="btnGuardarCliente">
            <span class="material-symbols-outlined">save</span>
            Guardar Cliente
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    let paginaActual = 1;
    const limite = 10;
    let ciudades = [];
    let colonias = [];

    document.addEventListener('DOMContentLoaded', async () => {
      await cargarCatalogos();
      await cargarClientes();
      
      // Eventos de filtros
      document.getElementById('inputBusqueda').addEventListener('input', debounce(() => {
        paginaActual = 1;
        cargarClientes();
      }, 500));
      
      document.getElementById('selectEstado').addEventListener('change', () => {
        paginaActual = 1;
        cargarClientes();
      });
      
      document.getElementById('selectCiudad').addEventListener('change', () => {
        paginaActual = 1;
        cargarClientes();
      });

      // Cargar colonias al cambiar ciudad
      document.getElementById('ciudad_id').addEventListener('change', cargarColoniasPorCiudad);
    });

    async function cargarCatalogos() {
      // Ciudades
      const dataCiudades = await fetchGet('/api/catalogos/ciudades');
      if (dataCiudades.ok) {
        ciudades = dataCiudades.ciudades || [];
        const selectCiudad = document.getElementById('selectCiudad');
        const selectCiudadForm = document.getElementById('ciudad_id');
        ciudades.forEach(c => {
          selectCiudad.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
          selectCiudadForm.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
        });
      }

      // Colonias
      const dataColonias = await fetchGet('/api/catalogos/colonias');
      if (dataColonias.ok) {
        colonias = dataColonias.colonias || [];
      }
    }

    function cargarColoniasPorCiudad() {
      const ciudadId = document.getElementById('ciudad_id').value;
      const selectColonia = document.getElementById('colonia_id');
      selectColonia.innerHTML = '<option value="">Seleccionar...</option>';
      
      const coloniasFiltered = colonias.filter(c => c.ciudad_id === ciudadId);
      coloniasFiltered.forEach(c => {
        selectColonia.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
      });
    }

    async function cargarClientes() {
      const busqueda = document.getElementById('inputBusqueda').value;
      const estado = document.getElementById('selectEstado').value;
      const ciudadId = document.getElementById('selectCiudad').value;

      let url = `/api/clientes?pagina=${paginaActual}&limite=${limite}`;
      if (busqueda) url += `&busqueda=${encodeURIComponent(busqueda)}`;
      if (estado !== 'todos') url += `&estado=${estado}`;
      if (ciudadId) url += `&ciudad_id=${ciudadId}`;

      const data = await fetchGet(url);
      const tabla = document.getElementById('tablaClientes');
      
      if (data.ok && data.clientes.length > 0) {
        tabla.innerHTML = data.clientes.map(c => `
          <tr onclick="window.location.href='cliente-detalle.html?id=${c.id}'" style="cursor:pointer">
            <td>
              <div class="font-bold">${c.nombre} ${c.apellido_paterno || ''} ${c.apellido_materno || ''}</div>
              <div class="text-muted" style="font-size:12px">${c.numero_cliente || ''}</div>
            </td>
            <td>${c.telefono || '-'}</td>
            <td>${c.ciudad_nombre || '-'}</td>
            <td>${formatoMoneda(c.tarifa_mensual || c.cuota_mensual)}</td>
            <td>
              ${c.saldo_pendiente > 0 ? `<span class="text-danger font-bold">${formatoMoneda(c.saldo_pendiente)}</span>` : ''}
              ${c.saldo_favor > 0 ? `<span class="text-success font-bold">+${formatoMoneda(c.saldo_favor)}</span>` : ''}
              ${!c.saldo_pendiente && !c.saldo_favor ? '<span class="text-muted">$0</span>' : ''}
            </td>
            <td>
              <span class="badge badge--${c.estado === 'activo' ? 'success' : c.estado === 'suspendido' ? 'warning' : 'danger'}">
                ${c.estado}
              </span>
            </td>
            <td>
              <button class="btn btn--sm btn--ghost" onclick="event.stopPropagation(); editarCliente('${c.id}')">
                <span class="material-symbols-outlined">edit</span>
              </button>
            </td>
          </tr>
        `).join('');

        // Info registros
        const inicio = (paginaActual - 1) * limite + 1;
        const fin = Math.min(paginaActual * limite, data.total);
        document.getElementById('infoRegistros').textContent = `Mostrando ${inicio}-${fin} de ${data.total}`;

        // Paginación
        renderPaginacion(data.totalPaginas);
      } else {
        tabla.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No se encontraron clientes</td></tr>';
        document.getElementById('infoRegistros').textContent = 'Sin resultados';
        document.getElementById('paginacion').innerHTML = '';
      }
    }

    function renderPaginacion(totalPaginas) {
      const container = document.getElementById('paginacion');
      if (totalPaginas <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '';
      html += `<button class="btn btn--sm btn--secondary" ${paginaActual === 1 ? 'disabled' : ''} onclick="cambiarPagina(${paginaActual - 1})">
        <span class="material-symbols-outlined">chevron_left</span>
      </button>`;
      
      for (let i = 1; i <= Math.min(totalPaginas, 5); i++) {
        html += `<button class="btn btn--sm ${paginaActual === i ? 'btn--primary' : 'btn--secondary'}" onclick="cambiarPagina(${i})">${i}</button>`;
      }
      
      html += `<button class="btn btn--sm btn--secondary" ${paginaActual === totalPaginas ? 'disabled' : ''} onclick="cambiarPagina(${paginaActual + 1})">
        <span class="material-symbols-outlined">chevron_right</span>
      </button>`;
      
      container.innerHTML = html;
    }

    function cambiarPagina(pagina) {
      paginaActual = pagina;
      cargarClientes();
    }

    function abrirModalCliente() {
      document.getElementById('modalClienteTitulo').textContent = 'Nuevo Cliente';
      document.getElementById('formCliente').reset();
      document.getElementById('clienteId').value = '';
      document.getElementById('previewIneFrente').classList.add('hidden');
      document.getElementById('previewIneReverso').classList.add('hidden');
      abrirModal('modalCliente');
    }

    async function editarCliente(id) {
      const data = await fetchGet(`/api/clientes/${id}`);
      if (!data.ok) {
        toastError('Error al cargar cliente');
        return;
      }

      const c = data.cliente;
      document.getElementById('modalClienteTitulo').textContent = 'Editar Cliente';
      document.getElementById('clienteId').value = c.id;
      document.getElementById('nombre').value = c.nombre || '';
      document.getElementById('apellido_paterno').value = c.apellido_paterno || '';
      document.getElementById('apellido_materno').value = c.apellido_materno || '';
      document.getElementById('telefono').value = c.telefono || '';
      document.getElementById('telefono_secundario').value = c.telefono_secundario || '';
      document.getElementById('telefono_terciario').value = c.telefono_terciario || '';
      document.getElementById('email').value = c.email || '';
      document.getElementById('direccion_calle').value = c.direccion_calle || '';
      document.getElementById('direccion_numero').value = c.direccion_numero || '';
      document.getElementById('direccion_interior').value = c.direccion_interior || '';
      document.getElementById('ciudad_id').value = c.ciudad_id || '';
      cargarColoniasPorCiudad();
      setTimeout(() => {
        document.getElementById('colonia_id').value = c.colonia_id || '';
      }, 100);
      document.getElementById('codigo_postal').value = c.codigo_postal || '';
      document.getElementById('referencia').value = c.referencia || '';

      // INE
      if (c.ine_frente) {
        document.getElementById('previewIneFrente').src = c.ine_frente;
        document.getElementById('previewIneFrente').classList.remove('hidden');
        document.getElementById('ine_frente').value = c.ine_frente;
      }
      if (c.ine_reverso) {
        document.getElementById('previewIneReverso').src = c.ine_reverso;
        document.getElementById('previewIneReverso').classList.remove('hidden');
        document.getElementById('ine_reverso').value = c.ine_reverso;
      }

      abrirModal('modalCliente');
    }

    async function guardarCliente(e) {
      e.preventDefault();
      const btn = document.getElementById('btnGuardarCliente');
      btnLoading(btn, true);

      const id = document.getElementById('clienteId').value;
      const datos = {
        nombre: document.getElementById('nombre').value,
        apellido_paterno: document.getElementById('apellido_paterno').value,
        apellido_materno: document.getElementById('apellido_materno').value,
        telefono: document.getElementById('telefono').value,
        telefono_secundario: document.getElementById('telefono_secundario').value,
        telefono_terciario: document.getElementById('telefono_terciario').value,
        email: document.getElementById('email').value,
        direccion_calle: document.getElementById('direccion_calle').value,
        direccion_numero: document.getElementById('direccion_numero').value,
        direccion_interior: document.getElementById('direccion_interior').value,
        ciudad_id: document.getElementById('ciudad_id').value || null,
        colonia_id: document.getElementById('colonia_id').value || null,
        codigo_postal: document.getElementById('codigo_postal').value,
        referencia: document.getElementById('referencia').value,
        ine_frente: document.getElementById('ine_frente').value,
        ine_reverso: document.getElementById('ine_reverso').value
      };

      let data;
      if (id) {
        data = await fetchPut(`/api/clientes/${id}`, datos);
      } else {
        data = await fetchPost('/api/clientes', datos);
      }

      btnLoading(btn, false);

      if (data.ok) {
        toastExito(id ? 'Cliente actualizado' : 'Cliente creado');
        cerrarModal('modalCliente');
        cargarClientes();
        
        // Si es nuevo, ir al detalle para instalación
        if (!id && data.cliente) {
          window.location.href = `cliente-detalle.html?id=${data.cliente.id}&nuevo=1`;
        }
      } else {
        toastError(data.mensaje || 'Error al guardar');
      }
    }

    async function previewImage(input, previewId, hiddenId) {
      const file = input.files[0];
      if (!file) return;

      const preview = document.getElementById(previewId);
      preview.src = URL.createObjectURL(file);
      preview.classList.remove('hidden');

      // Subir a Cloudinary
      toastInfo('Subiendo imagen...');
      const url = await subirImagenCloudinary(file, 'skynet/ine');
      if (url) {
        document.getElementById(hiddenId).value = url;
        toastExito('Imagen subida');
      } else {
        toastError('Error al subir imagen');
      }
    }
  </script>
</body>
</html>
