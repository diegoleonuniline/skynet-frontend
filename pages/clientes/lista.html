<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clientes - Skynet ISP</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../css/styles.css">
</head>
<body>
  <div class="page-header">
    <div>
      <h1 class="page-title">Clientes</h1>
      <p class="page-subtitle">Gestiona los clientes del sistema</p>
    </div>
    <a href="nuevo.html" class="btn btn-primary">+ Nuevo Cliente</a>
  </div>

  <!-- Filtros -->
  <div class="card" style="margin-bottom: 16px;">
    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
      <input type="text" class="form-input" id="searchInput" placeholder="Buscar por nombre, n√∫mero o tel√©fono..." style="flex: 1; min-width: 250px;">
      <select class="form-select" id="estadoFilter" style="width: 180px;">
        <option value="">Todos los estados</option>
      </select>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card" style="padding: 0;">
    <div class="table-container">
      <table class="table" id="clientesTable">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Contacto</th>
            <th>Ubicaci√≥n</th>
            <th>Adeudo</th>
            <th>Estado</th>
            <th style="width: 100px;">Acciones</th>
          </tr>
        </thead>
        <tbody id="clientesBody">
          <tr><td colspan="6" class="loading"><div class="spinner"></div></td></tr>
        </tbody>
      </table>
    </div>
    
    <div style="padding: 16px; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
      <span id="paginationInfo" class="text-gray"></span>
      <div style="display: flex; gap: 8px;">
        <button class="btn btn-outline btn-sm" id="prevBtn" disabled>‚Üê Anterior</button>
        <button class="btn btn-outline btn-sm" id="nextBtn" disabled>Siguiente ‚Üí</button>
      </div>
    </div>
  </div>

  <script src="../../js/api.js"></script>
  <script src="../../js/layout.js"></script>
  <script>
    initLayout('clientes');

    let currentPage = 1;
    let totalPages = 1;

    // Cargar estados
    async function loadEstados() {
      try {
        const data = await api.get('/catalogos/estados_cliente');
        const select = document.getElementById('estadoFilter');
        data.data.forEach(e => {
          select.innerHTML += `<option value="${e.id}">${e.nombre}</option>`;
        });
      } catch (error) {
        console.error('Error cargando estados');
      }
    }

    // Cargar clientes
    async function loadClientes() {
      const search = document.getElementById('searchInput').value;
      const estado = document.getElementById('estadoFilter').value;
      
      const params = new URLSearchParams();
      if (search) params.append('busqueda', search);
      if (estado) params.append('estado_id', estado);
      params.append('page', currentPage);
      params.append('limit', 15);

      try {
        const data = await api.get(`/clientes?${params}`);
        const clientes = data.data;
        const pagination = data.pagination;

        totalPages = pagination.pages;
        
        document.getElementById('paginationInfo').textContent = 
          `Mostrando ${((currentPage - 1) * 15) + 1} - ${Math.min(currentPage * 15, pagination.total)} de ${pagination.total}`;
        
        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;

        if (clientes.length === 0) {
          document.getElementById('clientesBody').innerHTML = `
            <tr><td colspan="6" class="empty-state">No se encontraron clientes</td></tr>
          `;
          return;
        }

        document.getElementById('clientesBody').innerHTML = clientes.map(c => `
          <tr class="clickable" onclick="window.location.href='detalle.html?id=${c.id}'">
            <td>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div class="user-avatar" style="width: 40px; height: 40px; font-size: 14px;">
                  ${utils.getInitials(c.nombre + ' ' + c.apellido_paterno)}
                </div>
                <div>
                  <div style="font-weight: 500;">${c.nombre} ${c.apellido_paterno} ${c.apellido_materno || ''}</div>
                  <div style="font-size: 12px; color: var(--gray-400);">${c.numero_cliente}</div>
                </div>
              </div>
            </td>
            <td>
              <div style="font-size: 14px;">üìû ${c.telefono_principal}</div>
              ${c.email ? `<div style="font-size: 12px; color: var(--gray-400);">‚úâÔ∏è ${c.email}</div>` : ''}
            </td>
            <td>
              <div style="font-size: 14px;">${c.colonia || '-'}</div>
              <div style="font-size: 12px; color: var(--gray-400);">${c.ciudad || ''}</div>
            </td>
            <td>
              <span class="${c.adeudo > 0 ? 'text-error font-semibold' : 'text-success'}">
                ${utils.formatMoney(c.adeudo)}
              </span>
            </td>
            <td>
              <span class="badge ${utils.getStatusBadge(c.estado)}">${c.estado}</span>
            </td>
            <td onclick="event.stopPropagation()">
              <a href="detalle.html?id=${c.id}" class="btn-icon" title="Ver">üëÅÔ∏è</a>
              ${api.isAdmin() ? `<a href="editar.html?id=${c.id}" class="btn-icon" title="Editar">‚úèÔ∏è</a>` : ''}
            </td>
          </tr>
        `).join('');

      } catch (error) {
        toast.error('Error al cargar clientes');
      }
    }

    // Eventos
    document.getElementById('searchInput').addEventListener('input', debounce(() => {
      currentPage = 1;
      loadClientes();
    }, 500));

    document.getElementById('estadoFilter').addEventListener('change', () => {
      currentPage = 1;
      loadClientes();
    });

    document.getElementById('prevBtn').addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        loadClientes();
      }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      if (currentPage < totalPages) {
        currentPage++;
        loadClientes();
      }
    });

    // Debounce helper
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Par√°metro de b√∫squeda en URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('busqueda')) {
      document.getElementById('searchInput').value = urlParams.get('busqueda');
    }

    loadEstados();
    loadClientes();
  </script>
</body>
</html>
